# Market Overview Page - API Optimization Guide

## Current API Calls Analysis

When the market overview page loads, the following API calls are made:

### 1. **Trading Opportunities (Lumo's Picks)** ‚úÖ OPTIMIZED
- **Endpoint:** `/api/trading/opportunities`
- **Uses:** OpenAI API (expensive)
- **Current:** Daily cache in PostgreSQL
- **Status:** ‚úÖ **Pre-generated at 8 AM ET via cron**
- **Cost Impact:** High ‚Üí Minimal

### 2. **Market Assets (SPY, BTC, EUR/USD, Oil)** ‚úÖ GOOD
- **Endpoint:** `/api/market/assets`
- **Uses:** FMP API (cheap, fast)
- **Refresh:** Every 30s during market hours
- **Status:** ‚úÖ Optimal - needs real-time data
- **Recommendation:** Keep as-is

### 3. **Market Indexes (SPY, QQQ, DIA, IWM)** ‚úÖ GOOD
- **Endpoint:** `/api/market/indexes`
- **Uses:** FMP API (cheap, fast)
- **Refresh:** Every 30s during market hours
- **Status:** ‚úÖ Optimal - needs real-time data
- **Recommendation:** Keep as-is

### 4. **Market News** ‚ö†Ô∏è CAN BE OPTIMIZED
- **Endpoint:** `/api/market/news`
- **Uses:** FMP API
- **Current:** Fetches on every page load, 10min cache
- **Recommendation:** 
  - ‚úÖ Already has reasonable caching (10 minutes)
  - Consider extending to 15-30 minutes (news doesn't change rapidly)
  - **Update in hook:** Change `staleTime` from 10 to 30 minutes

### 5. **Market Predictions (AI Model)** ‚úÖ GOOD
- **Endpoint:** `/api/ml/today-prediction` (ML Backend)
- **Uses:** PostgreSQL (pre-generated by ML model)
- **Status:** ‚úÖ Already cached daily by ML backend
- **Recommendation:** Keep as-is

### 6. **Market Status** ‚úÖ GOOD
- **Endpoint:** `/api/market/status`
- **Uses:** Local calculation + FMP
- **Status:** ‚úÖ Lightweight, no optimization needed
- **Recommendation:** Keep as-is

### 7. **Economic Calendar** ‚úÖ GOOD (If Used)
- **Endpoint:** `/api/market/calendar`
- **Uses:** FMP API
- **Status:** ‚úÖ Data changes infrequently
- **Recommendation:** Keep as-is

### 8. **Research Insights** (If Used) ‚úÖ GOOD
- **Endpoint:** `/api/market/research`
- **Status:** Component-specific, likely cached
- **Recommendation:** Keep as-is

## Recommended Optimizations

### Priority 1: ‚úÖ DONE - Pre-Generate Lumo's Picks
- **Status:** Completed
- **Impact:** High (saves $60/month)
- **Implementation:** Cron job at 8 AM ET

### Priority 2: ‚ö° Extend News Cache (Quick Win)

**File:** `/hooks/useMarketNews.ts`

**Change:**
```typescript
// From:
staleTime: 10 * 60 * 1000, // 10 minutes

// To:
staleTime: 30 * 60 * 1000, // 30 minutes
```

**Impact:** 
- Reduces FMP API calls by 66%
- News doesn't change every 10 minutes
- Users won't notice the difference

### Priority 3: üîÑ Consider Pre-Generating (Future)

#### A. AI Brief Summaries
- **Endpoint:** `/api/market/ai-brief`
- **Currently:** Generated on-demand with OpenAI
- **Recommendation:** Pre-generate at 8 AM ET
- **Complexity:** Medium
- **Savings:** ~$20-30/month

#### B. Popular Stock Thesis
- **Endpoint:** `/api/stock/ai-thesis/[symbol]`
- **Currently:** Generated on-demand for each stock
- **Recommendation:** Pre-generate for SPY, QQQ, AAPL, TSLA, NVDA
- **Complexity:** Medium
- **Savings:** ~$10-15/month

#### C. Market Metrics
- **Endpoint:** `/api/market/metrics`
- **Currently:** Computed on each request
- **Recommendation:** Cache for 5-15 minutes
- **Complexity:** Low
- **Savings:** Reduces compute time

## Implementation Plan

### Phase 1: ‚úÖ COMPLETED
- [x] Create pre-market generation endpoint
- [x] Add Lumo's Picks pre-generation
- [x] Set up cron job infrastructure
- [x] Document the system

### Phase 2: Quick Wins
- [ ] Extend news cache to 30 minutes
- [ ] Add market metrics caching (5-15 min)
- [ ] Monitor API usage for 1 week

### Phase 3: Advanced Optimization
- [ ] Pre-generate AI Brief summaries
- [ ] Pre-generate popular stock thesis
- [ ] Add cache warming for trending stocks
- [ ] Implement Redis for ultra-fast caching

## Monitoring

### Check API Usage
```bash
# Count daily API calls in logs
vercel logs --prod | grep "API call" | wc -l

# Check cache hit rate
vercel logs --prod | grep "cache.*hit" | wc -l
```

### Cost Tracking
Monitor these services:
- **OpenAI:** https://platform.openai.com/usage
- **FMP:** https://site.financialmodelingprep.com/developer/docs
- **Vercel:** https://vercel.com/usage

## Best Practices

### When to Cache
‚úÖ **Cache These:**
- AI-generated content (expensive, changes daily)
- News (changes infrequently)
- Market analysis (changes hourly/daily)
- Historical data (never changes)

‚ùå **Don't Cache These:**
- Real-time prices (need live data)
- User-specific data
- Trade executions
- Authentication state

### Cache Duration Guidelines
- **Real-time data:** 30 seconds
- **Market data:** 5-15 minutes
- **News/Analysis:** 30-60 minutes
- **AI content:** Daily (pre-generated)
- **Historical data:** Forever (immutable)

## Files Modified

### Created:
- `/app/api/cron/premarket-generation/route.ts` - Pre-generation endpoint
- `/docs/PREMARKET_GENERATION.md` - Setup documentation
- `/scripts/trigger-premarket-generation.sh` - Cron trigger script
- `/.github/workflows/premarket-generation.yml` - GitHub Actions workflow
- This file - Optimization guide

### To Update (Phase 2):
- `/hooks/useMarketNews.ts` - Extend cache to 30 min
- `/app/api/market/metrics/route.ts` - Add caching

## Expected Cost Savings

### Before Optimization
- Trading Opportunities: $60/month
- Total API costs: ~$100/month

### After Optimization
- Trading Opportunities: $0.60/month (99% reduction)
- With Phase 2-3: ~$40-50/month total
- **Total Savings: 50-60% reduction**

## Questions?

See `/docs/PREMARKET_GENERATION.md` for detailed setup instructions.

